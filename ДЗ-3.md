
# Homework Instructions and Notes (Revised)

## 1.    Создать таблицу с текстовым полем и заполнить случайными или сгенерированными данным в размере 1 млн строк

### команда:
```sql
CREATE TABLE random_data (
   id SERIAL PRIMARY KEY,
   random_text TEXT
);

INSERT INTO random_data (random_text)
   SELECT md5(random()::text)
   FROM generate_series(1, 1000000);
```

---

## 2.    Посмотреть размер файла с таблицей

### команда:
```sql
SELECT pg_size_pretty(pg_total_relation_size('random_data'));
-- Output: 87 MB
```

или на диске

#### i) нашел OID:
```sql
SELECT oid, datname FROM pg_database WHERE datname = 'postgres';
-- вывод: 5 | postgres
```

#### ii) нашел relfilenode:
```sql
SELECT oid, datname FROM pg_database WHERE datname = 'postgres';
-- вывод: 16389
```

#### iii) посмотрел на диске:
```bash
\! ls -l /var/lib/postgresql/data/base/5 | grep 16389
# вывод:
-rw------- 1 postgres postgres 68272128 Oct 11 08:26 16389
-rw------- 1 postgres postgres    40960 Oct 11 08:20 16389_fsm
-rw------- 1 postgres postgres     8192 Oct 11 08:20 16389_vm
```
размер файла на диске: 65 MB

#### iv) использование места на диске базой:
```bash
\! du -sh /var/lib/postgresql/data/base/5
# Output: 94M /var/lib/postgresql/data/base/5
```

**Note:**  значение таблицы 87 немного разнится с дисковым значением, неуверен почему, возможно из-за метаданных и механизме хранения..

---

## 3. 5 раз обновить все строчки и добавить к каждой строчке любой символ

### команда:
```sql
DO $$
BEGIN
    FOR i IN 1..5 LOOP
        UPDATE random_data
        SET random_text = random_text || 'A';
    END LOOP;
END $$;
```

---

## 4. Посмотреть количество мертвых строчек в таблице и когда последний раз приходил автовакуум

### команда:
```sql
SELECT n_dead_tup, last_autovacuum
FROM pg_stat_user_tables
WHERE relname = 'random_data';
-- вывод: 0 | 2024-10-11 08:42:31.395293+00 //вакуум сразу отработал, не заставил себя ждать
```

автовакуум сразу отработал и размер увеличился с 87 до 492Мб

```sql
SELECT pg_size_pretty(pg_total_relation_size('random_data'));
-- вывод: 492 MB
```

---

## 5. Подождать некоторое время, проверяя, пришел ли автовакуум

сделал вручную автовакуум фул
```sql
VACUUM FULL random_data;
```

проверил обратно:
```sql
postgres=# vacuum full random_data;
VACUUM
postgres=# select n_dead_tup,                                           
       last_autovacuum
from pg_stat_user_tables
where relname = 'random_data';
          0 | 2024-10-11 08:42:31.395293+00

postgres=# SELECT pg_size_pretty(pg_total_relation_size('random_data'));
 94 MB

```

---

## 6. 5 раз обновить все строчки и добавить к каждой строчке любой символ

```sql

postgres=# SELECT pg_size_pretty(pg_total_relation_size('random_data'));
 94 MB

postgres=# select n_dead_tup,                               
       last_autovacuum
from pg_stat_user_tables
where relname = 'random_data';
          0 | 2024-10-11 08:42:31.395293+00

postgres=# DO $$            
BEGIN                  
    FOR i IN 1..5 LOOP                                                                                                
        UPDATE random_data
        SET random_text = random_text || 'A'; 
    END LOOP;
END $$;
DO
postgres=# select n_dead_tup,
       last_autovacuum
from pg_stat_user_tables
where relname = 'random_data';
    5000000 | 2024-10-11 08:42:31.395293+00


```

---

## 7.  Посмотреть размер файла с таблицей

```sql
SELECT pg_size_pretty(pg_total_relation_size('random_data'));
-- вывод: 524 MB
```

---

## 8. Отключить Автовакуум на конкретной таблице

### команда:
```sql
ALTER TABLE random_data SET (autovacuum_enabled = false);
```

---

## 9. 10 раз обновить все строчки и добавить к каждой строчке любой символ

### команда:
```sql
DO $$
BEGIN
    FOR i IN 1..10 LOOP
        UPDATE random_data
        SET random_text = random_text || 'A'; 
    END LOOP;
END $$;
```

---

## 10. Посмотреть размер файла с таблицей

### Command:
```sql
SELECT pg_size_pretty(pg_total_relation_size('random_data'));
-- вывод: 966 MB
```

---

## 11. Объясните полученный результат

автовакуум в PostgreSQL помогает уменьшать размер таблиц очищая старые или удаленные записи, возвращая место для новых данных. 
Хотя это не уменьшает размер файла на диске сразу, оно делает место доступным для дальнейшего использования. 
Если нужно сильно уменьшить размер таблицы на диске, можно использовать команду VACUUM FULL, которая полностью перестраивает таблицу и освобождает место.


---

## 12. Не забудьте включить автовакуум)

### Command:
```sql
ALTER TABLE random_data SET (autovacuum_enabled = true);
```
размер
```sql
SELECT pg_size_pretty(pg_total_relation_size('random_data'));
-- Output: 966 MB
```

вакуум
```sql
VACUUM FULL random_data;
```

конечный размер
```sql
SELECT pg_size_pretty(pg_total_relation_size('random_data'));
-- Output: 110 MB
```

---
