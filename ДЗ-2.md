
# ДЗ Пошаговая инструкция

1. Открыть консоль и зайти по SSH на ВМ:
   ```bash
   docker exec -ti postgres bash
   ```

2. Открыть вторую консоль и также зайти по SSH на ту же ВМ (можно в докере 2 сеанса):
   ```bash
   docker exec -ti postgres bash
   ```

3. Запустить везде psql из-под пользователя postgres:
   ```bash
   psql -U postgres
   ```

4. Сделать в первой сессии новую таблицу и наполнить её данными:
   ```sql
   CREATE TABLE test_isolation (
       id SERIAL PRIMARY KEY,
       name VARCHAR(100),
       balance DECIMAL(10, 2)
   );

   INSERT INTO test_isolation (name, balance)
   SELECT 
       'User ' || gs,
       round((random() * 1000)::numeric, 2)
   FROM generate_series(1, 5) AS gs;
   ```

5. Посмотреть текущий уровень изоляции:
   ```sql
   SHOW TRANSACTION ISOLATION LEVEL;
   ```
   Ответ: `read committed`

6. Начать новую транзакцию в обеих сессиях с дефолтным (не меняя) уровнем изоляции:
   В обоих терминалах:
   ```sql
   BEGIN; -- для начала транзакции
   ```

7. В первой сессии добавить новую запись:
   В первом терминале:
   ```sql
   INSERT INTO test_isolation (name, balance) VALUES ('zhenis', 0.01);
   SELECT * FROM test_isolation;
   ```
   ```
   id |  name  | balance 
   ----+--------+---------
   1 | User 1 |   79.71
   2 | User 2 |  933.56
   3 | User 3 |   46.96
   4 | User 4 |  129.11
   5 | User 5 |  908.74
   6 | zhenis |    0.01
   ```

8. Сделать запрос на выбор всех записей во второй сессии:
   ```sql
   SELECT * FROM test_isolation;
   ```
   ```
   id |  name  | balance 
   ----+--------+---------
   1 | User 1 |   79.71
   2 | User 2 |  933.56
   3 | User 3 |   46.96
   4 | User 4 |  129.11
   5 | User 5 |  908.74
   (5 rows)
   ```
9. Видите ли вы новую запись и если да то почему? После задания можете сверить
правильный ответ с эталонным (будет доступен после 3 лекции)
   ```
   Записи не видно, потому как уровень изоляции `read committed`. Пока не закоммичу, то запись не будет видна никому из вне транзакции.
   ```

10. Завершить транзакцию в первом окне:
   ```
   Завершил транзакцию с помощью `commit;`
   ```

11. Сделать запрос на выбор всех записей во второй сессии:
   ```sql
   SELECT * FROM test_isolation;
   ```
   ```
   id |  name  | balance 
   ----+--------+---------
   1 | User 1 |   79.71
   2 | User 2 |  933.56
   3 | User 3 |   46.96
   4 | User 4 |  129.11
   5 | User 5 |  908.74
   6 | zhenis |    0.01
   (6 rows)
   ```

12. Видите ли вы новую запись и если да, то почему?
   ```
   Да, запись видна, потому как первая транзакция, где была добавлена новая запись, была закоммичена (`commit`),
   и теперь из-за соответствующего уровня изоляции наша новая запись видна другим транзакциям.
   ```
13. Завершите транзакцию во второй сессии:
   ```sql
   COMMIT;
   ```

14. Начать новые транзакции, но уже на уровне `repeatable read` в обеих сессиях:
   ```sql
   BEGIN TRANSACTION ISOLATION LEVEL REPEATABLE READ;
   ```

15. В первой сессии добавить новую запись:
   ```sql
   INSERT INTO test_isolation (name, balance) VALUES ('zhenis2', 0.02);
   ```

16. Сделать запрос на выбор всех записей во второй сессии:
   ```sql
   SELECT * FROM test_isolation;
   ```
   ```
   id |  name  | balance 
   ----+--------+---------
   1 | User 1 |   79.71
   2 | User 2 |  933.56
   3 | User 3 |   46.96
   4 | User 4 |  129.11
   5 | User 5 |  908.74
   6 | zhenis |    0.01
   (6 rows)
   ```

17. Видите ли вы новую запись и если да, то почему?
   ```
   Не вижу, потому как транзакция не завершена и данные не закомичены. 
   Изоляция `repeatable read` включает условия `read committed`, а также дополнительно гарантирует, что все строки,
   прочитанные в транзакции, останутся неизменными на протяжении всей транзакции.
   ```

18. Завершить транзакцию в первом окне:
   ```sql
   COMMIT;
   ```

19. Сделать запрос на выбор всех записей во второй сессии:
   ```sql
   SELECT * FROM test_isolation;
   ```
   ```
   id |  name  | balance 
   ----+--------+---------
   1 | User 1 |   79.71
   2 | User 2 |  933.56
   3 | User 3 |   46.96
   4 | User 4 |  129.11
   5 | User 5 |  908.74
   6 | zhenis |    0.01
   (6 rows)
   ```

20. Видите ли вы новую запись и если да, то почему?
   ```
   Не вижу, потому как идет условие того, что данные останутся неизменными. Если бы я не запрашивал ранее данные, то я бы мог их увидеть.
   Нет, не вижу, потому как транзакция второго терминала видит только то, что было до. Прочитанные в транзакции строки останутся неизменными. 
   К примеру, если бы я создал две транзакции `repeatable read`, сделал новую запись, закомитил её и уже потом запросил данные таблицы во второй транзакции, тогда я бы увидел новую запись.
   ```
